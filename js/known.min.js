"use strict";var Security=Security||{};Security.tokens=[],Security.getCSRFToken=function(t,e){null==e&&(e=known.currentPageUrl);for(var n=Math.floor(Date.now()/1e3),o=0;o<Security.tokens.length;o++)Security.tokens[o].url==e&&Security.tokens[o].time>n-100&&(console.log("Returning cached token for "+e),t(Security.tokens[o].token,Security.tokens[o].time));$.ajax({type:"GET",data:{url:e},url:known.config.displayUrl+"service/security/csrftoken/"}).done(function(n,o,i){Security.tokens.push({token:n.token,time:n.time,url:e}),t(n.token,n.time)})},Security.refreshTokens=function(){$(".known-security-token").each(function(){var t=$(this).closest("form");Security.getCSRFToken(function(e,n){t.find("input[name=__bTk]").val(e),t.find("input[name=__bTs]").val(n)},t.find("input[name=__bTa]").val())})},setInterval(function(){Security.refreshTokens()},3e5),Security.activateACLControls=function(){$(".acl-ctrl-option").each(function(){$(this).data("acl")==$(this).closest(".access-control-block").find("input").val()&&$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>')}),$(".acl-ctrl-option").on("click",function(){$(this).closest(".access-control-block").find("input").val($(this).data("acl")),$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>'),$(this).closest(".btn-group").find(".dropdown-toggle").click()})},$(document).ready(function(){Security.activateACLControls()});var Logger=Logger||{};Logger.log=function(t,e){switch(void 0===e&&(e="INFO"),e.toUpperCase()){case"ALERT":case"ERROR":case"EXCEPTION":e="ERROR",console.error(e+": "+t);break;case"WARN":case"WARNING":e="WARNING",console.warn(e+": "+t);break;default:e="INFO",console.log(e+": "+t)}Security.getCSRFToken(function(n,o){$.ajax({type:"POST",data:{level:e,message:t,__bTk:n,__bTs:o},url:known.config.displayUrl+"service/system/log/"})},known.config.displayUrl+"service/system/log/")},Logger.info=function(t){Logger.log(t,"INFO")},Logger.warn=function(t){Logger.log(t,"WARN")},Logger.error=function(t){Logger.log(t,"ERROR")},Logger.deprecated=function(t){Logger.info("DEPRECATED "+t)},Logger.errorHandler=function(t){var e=t.error.stack,n=t.error.toString();e&&(n+="\n"+e),console.error(t),Logger.log(n,"ERROR")},window.addEventListener("error",function(t){Logger.errorHandler(t)});var Notifications=Notifications||{};function doPoll(){Notifications.poll()}function wwwroot(){return known.config.displayUrl}function isLoggedIn(){return!("undefined"==typeof known||!known.session.loggedIn)}Notifications.poll=function(){$.get(known.config.displayUrl+"service/notifications/new-notifications").done(function(t){if(t.notifications&&t.notifications.length>0)for(var e=0;e<t.notifications.length;e++){var n=t.notifications[e].title,o=t.notifications[e].body,i=t.notifications[e].icon,a=t.notifications[e].link;try{new Notification(n,{icon:i,body:o,data:a}).onclick=function(t){window.location.href=a}}catch(t){}}}).fail(function(t){})},Notifications.enable=function(t){known.session.loggedIn&&("Notification"in window?(self.addEventListener("notificationclick",function(t){window.location.href=t.notification.data}),"denied"===Notification.permission||"granted"===Notification.permission||t?"granted"===Notification.permission&&setInterval(Notifications.poll,3e4):Notification.requestPermission(function(t){"granted"===t&&setInterval(Notifications.poll,3e4)})):console.log("The Notification API is not supported by this browser"))},Notifications.isEnabled=function(){return!!known.session.loggedIn&&("Notification"in window?"granted"===Notification.permission:(console.log("The Notification API is not supported by this browser"),!1))},$(document).ready(function(){Notifications.isEnabled()&&Notifications.enable(!0)}),$(document).ready(function(){var t=$("#soft-forward").attr("href");t&&(window.location=t),known.session.loggedIn});var Unfurl=Unfurl||{};Unfurl.fetch=function(t,e){t.length>0&&Security.getCSRFToken(function(n,o){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:t,__bTk:n,__bTs:o},function(t){e(t)})},known.config.displayUrl+"service/web/unfurl/")},Unfurl.getUrls=function(t){console.log(t);var e=new RegExp("(https?://[^\\s]+)","gi");return t.match(e)},Unfurl.getFirstUrl=function(t){var e=Unfurl.getUrls(t);return null!=e&&e.length>0?e[0]:""},Unfurl.initOembed=function(t){var e=t.find("div.oembed");if(null!=e){var n=e.attr("data-url"),o=e.attr("data-format");null!=n&&(console.log("Fetching oembed code from "+n+" using "+o),$.ajax({url:n,dataType:o,success:function(t){if(console.log("Got a response back"),"xml"==o){console.log("XML Format");var n=$(t).find("html").text();n.indexOf("CDATA")>-1&&(n=n.substr(9,n.length-12)),e.html(n)}else console.log("JSON Format oembed"),e.html(t.html);e.closest(".unfurled-url").find(".basics").hide()},error:function(t){console.error("Problem fetching oembed as "+o+" trying to map a different way..."),"jsonp"==o?o="json":"json"==o&&(o="jsonp"),$.ajax({url:n,dataType:o,success:function(t){e.html(t.html),e.closest(".unfurled-url").find(".basics").hide()},error:function(t){console.error("Giving up trying to fetch oembed url "+n+" as "+o)}})}}))}},Unfurl.enableControls=function(t){var e=t.attr("data-url"),n=t.closest(".unfurl-block"),o=n.find(".unfurl-edit a.refresh"),i=n.find(".unfurl-edit a.delete");n.find(".unfurl-edit").show(),o.click(function(n){Security.getCSRFToken(function(n,o){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:e,forcenew:!0,__bTk:n,__bTs:o},success:function(e){console.log("Refreshed"),t.fadeOut().fadeIn(),Unfurl.unfurl(t)}})},known.config.displayUrl+"service/web/unfurl/"),n.preventDefault()}),i.click(function(t){Security.getCSRFToken(function(t,e){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+n.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:t,__bTs:e},success:function(t){console.log("Refresh: deleted"),n.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+n.attr("data-parent-object")+"/"),t.preventDefault()})},Unfurl.unfurl=function(t){var e=t.attr("data-url");null!=e&&Unfurl.fetch(e,function(e){t.html(e.rendered),t.show(),Unfurl.initOembed(t),Template.enableImageFallback(),Unfurl.enableControls(t)})},Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})},$(document).ready(function(){Unfurl.unfurlAll()});var ImageTools=ImageTools||{};function base64ToArrayBuffer(t){return ImageTools.base64ToArrayBuffer(t)}function exifRotateImg(t,e,n){ImageTools.exifRotateImg(t,e,n)}ImageTools.base64ToArrayBuffer=function(t){t=t.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var e=atob(t),n=e.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=e.charCodeAt(i);return o.buffer},ImageTools.exifRotateImg=function(t,e,n){var o,i=$(t).height(),a=$(t).width();switch(0==a&&(a=300),0==i&&(i=200),e){case 8:o=-90,$(t).css("transform-box","fill-box"),$(t).css("transform-origin","0 0"),$(t).css("transform","rotate("+o+"deg)"),$(t).css("-webkit-transform","rotate("+o+"deg)"),$(t).css("-ms-transform","rotate("+o+"deg)"),$(t).css("margin-left","100%"),$(n).css("width",a+"px"),$(n).css("height",a+"px");break;case 3:o=180,$(t).css("transform-box","fill-box"),$(t).css("transform-origin","0 0"),$(t).css("transform","rotate("+o+"deg)"),$(t).css("-webkit-transform","rotate("+o+"deg)"),$(t).css("-ms-transform","rotate("+o+"deg)");break;case 6:o=90,$(t).css("transform-origin","0 0"),$(t).css("transform-box","fill-box"),$(t).css("margin-left","100%"),$(t).css("transform","rotate("+o+"deg)"),$(t).css("-webkit-transform","rotate("+o+"deg)"),$(t).css("-ms-transform","rotate("+o+"deg)"),$(n).css("width",a+"px"),$(n).css("height",a+"px")}};var Template=Template||{};function addMessage(t,e){Template.addMessage(t)}function addErrorMessage(t){Template.addErrorMessage(t)}function bindControls(){Template.bindControls()}function contentCreateForm(t,e){Template.initContentCreateForm(t,e)}function hideContentCreateForm(){Template.hideContentCreateForm()}function autoSave(t,e,n){return Template.autoSave(t,e,n)}function annotateContent(){$(".h-entry").fitVids(),$("time.dt-published").timeago()}Template.addMessage=function(t,e){void 0===e&&(e="alert-info"),void 0!==t&&$("div#page-messages").append('<div class="alert '+e+' col-md-10 col-md-offset-1"><button type="button" class="close" data-dismiss="alert">&times;</button>'+t+"</div>")},Template.addErrorMessage=function(t){Template.addMessage(t,"alert-danger")},Template.activateStarToggle=function(){$(".interactions .annotate-icon a.stars-toggle").each(function(){var t=$(this).attr("data-form-id"),e=$(this).find("i.fa"),n=e.closest("span.annotate-icon").find("a.stars");$("#"+t).submit(function(t){t.preventDefault(),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(t){e.hasClass("fa-star")&&e.hasClass("far")?e.removeClass("far").addClass("fas"):e.removeClass("fas").addClass("far"),n.text(t.text)}})})})},Template.enableFormCandy=function(){$(".ctrl-enter-submit").keypress(function(t){var e=t.which?t.which:t.keyCode;10!=e&&13!=e||!t.ctrlKey&&!t.metaKey||$(this).closest("form").submit()})},Template.enablePagination=function(){$(".pager-xhr a").click(function(t){t.preventDefault();var e,n=$(this).closest(".pager-xhr"),o=parseInt(n.attr("data-offset")),i=parseInt(n.attr("data-limit")),a=parseInt(n.attr("data-count")),r=$("#"+n.attr("data-control-id")),s=n.attr("data-source-url"),l=$(this).attr("rel"),c=$(this).closest(".pager-xhr").find("li.newer"),f=$(this).closest(".pager-xhr").find("li.older");s=s.split("?")[0],"next"==l?(e=o-i)<0&&(e=0):(e=o+i)>a-1&&(e=a-1),s=s+"?offset="+e.toString()+"&limit="+i.toString(),r.load(s,function(t,o,s){"error"!=o&&(n.attr("data-offset",e.toString()),c.removeClass("pagination-disabled"),f.removeClass("pagination-disabled"),0==e&&c.addClass("pagination-disabled"),e>a-i&&f.addClass("pagination-disabled"),r.scrollTop(0))})})},Template.enableRichTextRequired=function(){$("textarea.validation-required").each(function(){var t=$(this).closest("form"),e=$(this),n=$(this).closest("div.richtext-container").find("div.alert");t.submit(function(t){n.hide(),0==e.val().length&&(t.preventDefault(),console.error("Required richtext field "+e.attr("name")+" is blank, preventing form submission"),n.show().focus())})})},Template.enableTooltips=function(){$('[data-toggle="tooltip"]').tooltip()},Template.enableImageFallback=function(){$("img").on("error",function(){console.error("Loading fallback image "+known.config.displayUrl+"gfx/users/default.png"),$(this).attr("src",known.config.displayUrl+"gfx/users/default.png")})},Template.activateImagePreview=function(t){var e=$(t).closest("div.image-file-input").find("div.photo-preview"),n=$(t).closest("div.image-file-input").find("span.photo-filename"),o=$(t).closest("div.image-file-input").find(".preview");if(t.files&&t.files[0]){var i=new FileReader;i.onload=function(t){n.html(n.attr("data-nexttext"));try{var i=EXIF.readFromBinaryFile(base64ToArrayBuffer(this.result));ImageTools.exifRotateImg("#"+o.attr("id"),i.Orientation,"#"+e.attr("id"))}catch(t){console.error(t)}o.attr("src",t.target.result),o.show()},i.readAsDataURL(t.files[0])}},Template.autoSave=function(t,e,n){var o={};setInterval(function(){for(var i={},a=0;a<e.length;a++){var r=e[a],s="#"+r;n&&r in n&&(s=n[r]);var l=!1;$(s).val()!=o[r]&&(l=$(s).val()),!1!==l&&(i[r]=l,o[r]=l)}Object.keys(i).length>0&&$.post(wwwroot()+"autosave/",{context:t,elements:i,names:e},function(){})},1e4)},Template.isCreateFormVisible=!1,Template.bindControls=function(){$(".acl-ctrl-option").click(function(){$("#access-control-id").val($(this).attr("data-acl")),$("#acl-text").html($(this).html())}),$(".syndication-toggle input[type=checkbox]").bootstrapToggle(),$('input[data-toggle="toggle"]').bootstrapToggle(),$(".ignore-this").hide(),Security.activateACLControls(),Template.enableFormCandy(),Template.enableRichTextRequired(),Template.enableTooltips(),$("#contentCreate .form-control").first().focus()},Template.initContentCreateForm=function(t,e){Template.isCreateFormVisible||(Template.isCreateFormVisible=!0,$.ajax(e,{dataType:"html",success:function(e){$("#contentCreate").html(e).slideDown(400),$("#contentTypeButtonBar").slideUp(400),window.contentCreateType=t,window.contentPage=!0,bindControls()},error:function(t){$("#contentTypeButtonBar").slideDown(400),Template.isCreateFormVisible=!1}}))},Template.hideContentCreateForm=function(){Template.isCreateFormVisible=!1,1==window.contentPage?($("#contentTypeButtonBar").slideDown(200),$("#contentCreate").slideUp(200)):window.history.length>1&&window.history.back()},function(t,e,n){if("standalone"in e&&e.standalone){var o,i=t.location,a=/^(a|html)$/i;t.addEventListener("click",function(t){for(o=t.target;!a.test(o.nodeName);)o=o.parentNode;"href"in o&&(o.href.indexOf("http")||~o.href.indexOf(i.host))&&!o.classList.contains("contentTypeButton")&&(t.preventDefault(),i.href=o.href)},!1)}}(document,window.navigator),$(document).ready(function(){$("body").on("click",function(t,e){var n=t.target;n.href&&-1===n.href.indexOf(window.location.origin)&&(n.target="_blank")})}),$(document).ready(function(){$.timeago.settings.cutoff=2592e6,annotateContent(),Template.enableFormCandy(),Template.enablePagination(),Template.enableRichTextRequired(),Template.enableImageFallback(),Template.activateStarToggle(),Template.enableTooltips()});