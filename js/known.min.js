"use strict";var Security=Security||{};Security.tokens=[],Security.getCSRFToken=function(e,t){null==t&&(t=known.currentPageUrl);for(var n=Math.floor(Date.now()/1e3),o=0;o<Security.tokens.length;o++)Security.tokens[o].url==t&&Security.tokens[o].time>n-100&&(console.log("Returning cached token for "+t),e(Security.tokens[o].token,Security.tokens[o].time));$.ajax({type:"GET",data:{url:t},url:known.config.displayUrl+"service/security/csrftoken/"}).done(function(n,o,i){Security.tokens.push({token:n.token,time:n.time,url:t}),e(n.token,n.time)})},Security.refreshTokens=function(){$(".known-security-token").each(function(){var e=$(this).closest("form");Security.getCSRFToken(function(t,n){e.find("input[name=__bTk]").val(t),e.find("input[name=__bTs]").val(n)},e.find("input[name=__bTa]").val())})},setInterval(function(){Security.refreshTokens()},3e5),Security.activateACLControls=function(){$(".acl-ctrl-option").each(function(){$(this).data("acl")==$(this).closest(".access-control-block").find("input").val()&&$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>')}),$(".acl-ctrl-option").on("click",function(){$(this).closest(".access-control-block").find("input").val($(this).data("acl")),$(this).closest(".btn-group").find(".dropdown-toggle").html($(this).html()+' <span class="caret"></span>'),$(this).closest(".btn-group").find(".dropdown-toggle").click()})},$(document).ready(function(){Security.activateACLControls()});var Logger=Logger||{};Logger.log=function(e,t){switch(void 0===t&&(t="INFO"),t.toUpperCase()){case"ALERT":case"ERROR":case"EXCEPTION":t="ERROR",console.error(t+": "+e);break;case"WARN":case"WARNING":t="WARNING",console.warn(t+": "+e);break;default:t="INFO",console.log(t+": "+e)}Security.getCSRFToken(function(n,o){$.ajax({type:"POST",data:{level:t,message:e,__bTk:n,__bTs:o},url:known.config.displayUrl+"service/system/log/"})},known.config.displayUrl+"service/system/log/")},Logger.info=function(e){Logger.log(e,"INFO")},Logger.warn=function(e){Logger.log(e,"WARN")},Logger.error=function(e){Logger.log(e,"ERROR")},Logger.deprecated=function(e){Logger.info("DEPRECATED "+e)},Logger.errorHandler=function(e){var t=e.error.stack,n=e.error.toString();t&&(n+="\n"+t),console.error(e),Logger.log(n,"ERROR")},window.addEventListener("error",function(e){Logger.errorHandler(e)});var Notifications=Notifications||{};function doPoll(){Notifications.poll()}function wwwroot(){return known.config.displayUrl}function isLoggedIn(){return!("undefined"==typeof known||!known.session.loggedIn)}Notifications.poll=function(){$.get(known.config.displayUrl+"service/notifications/new-notifications").done(function(e){if(e.notifications&&e.notifications.length>0)for(var t=0;t<e.notifications.length;t++){var n=e.notifications[t].title,o=e.notifications[t].body,i=e.notifications[t].icon,a=e.notifications[t].link;try{new Notification(n,{icon:i,body:o,data:a}).onclick=function(e){window.location.href=a}}catch(e){}}}).fail(function(e){})},Notifications.enable=function(e){known.session.loggedIn&&("Notification"in window?(self.addEventListener("notificationclick",function(e){window.location.href=e.notification.data}),"denied"===Notification.permission||"granted"===Notification.permission||e?"granted"===Notification.permission&&setInterval(Notifications.poll,3e4):Notification.requestPermission(function(e){"granted"===e&&setInterval(Notifications.poll,3e4)})):console.log("The Notification API is not supported by this browser"))},Notifications.isEnabled=function(){return!!known.session.loggedIn&&("Notification"in window?"granted"===Notification.permission:(console.log("The Notification API is not supported by this browser"),!1))},$(document).ready(function(){Notifications.isEnabled()&&Notifications.enable(!0)}),$(document).ready(function(){var e=$("#soft-forward").attr("href");e&&(window.location=e),known.session.loggedIn});var Unfurl=Unfurl||{};Unfurl.fetch=function(e,t){e.length>0&&Security.getCSRFToken(function(n,o){$.getJSON(known.config.displayUrl+"service/web/unfurl/",{url:e,__bTk:n,__bTs:o},function(e){t(e)})},known.config.displayUrl+"service/web/unfurl/")},Unfurl.getUrls=function(e){console.log(e);var t=new RegExp("(https?://[^\\s]+)","gi");return e.match(t)},Unfurl.getFirstUrl=function(e){var t=Unfurl.getUrls(e);return null!=t&&t.length>0?t[0]:""},Unfurl.initOembed=function(e){var t=e.find("div.oembed");if(null!=t){var n=t.attr("data-url"),o=t.attr("data-format");null!=n&&(console.log("Fetching oembed code from "+n+" using "+o),$.ajax({url:n,dataType:o,success:function(e){if(console.log("Got a response back"),"xml"==o){console.log("XML Format");var n=$(e).find("html").text();n.indexOf("CDATA")>-1&&(n=n.substr(9,n.length-12)),t.html(n)}else console.log("JSON Format oembed"),t.html(e.html);t.closest(".unfurled-url").find(".basics").hide()},error:function(e){console.error("Problem fetching oembed as "+o+" trying to map a different way..."),"jsonp"==o?o="json":"json"==o&&(o="jsonp"),$.ajax({url:n,dataType:o,success:function(e){t.html(e.html),t.closest(".unfurled-url").find(".basics").hide()},error:function(e){console.error("Giving up trying to fetch oembed url "+n+" as "+o)}})}}))}},Unfurl.enableControls=function(e){var t=e.attr("data-url"),n=e.closest(".unfurl-block"),o=n.find(".unfurl-edit a.refresh"),i=n.find(".unfurl-edit a.delete");n.find(".unfurl-edit").show(),o.click(function(n){Security.getCSRFToken(function(n,o){$.ajax(known.config.displayUrl+"service/web/unfurl/",{dataType:"json",method:"GET",data:{url:t,forcenew:!0,__bTk:n,__bTs:o},success:function(t){console.log("Refreshed"),e.fadeOut().fadeIn(),Unfurl.unfurl(e)}})},known.config.displayUrl+"service/web/unfurl/"),n.preventDefault()}),i.click(function(e){Security.getCSRFToken(function(e,t){$.ajax(known.config.displayUrl+"service/web/unfurl/remove/"+n.attr("data-parent-object")+"/",{dataType:"json",method:"POST",data:{__bTk:e,__bTs:t},success:function(e){console.log("Refresh: deleted"),n.fadeOut()}})},known.config.displayUrl+"service/web/unfurl/remove/"+n.attr("data-parent-object")+"/"),e.preventDefault()})},Unfurl.unfurl=function(e){var t=e.attr("data-url");null!=t&&Unfurl.fetch(t,function(t){e.html(t.rendered),e.show(),Unfurl.initOembed(e),Template.enableImageFallback(),Unfurl.enableControls(e)})},Unfurl.unfurlAll=function(){$("div.unfurl").each(function(){Unfurl.unfurl($(this))})},$(document).ready(function(){Unfurl.unfurlAll()});var ImageTools=ImageTools||{};function base64ToArrayBuffer(e){return ImageTools.base64ToArrayBuffer(e)}function exifRotateImg(e,t,n){ImageTools.exifRotateImg(e,t,n)}ImageTools.base64ToArrayBuffer=function(e){e=e.replace(/^data\:([^\;]+)\;base64,/gim,"");for(var t=atob(e),n=t.length,o=new Uint8Array(n),i=0;i<n;i++)o[i]=t.charCodeAt(i);return o.buffer},ImageTools.exifRotateImg=function(e,t,n){var o,i=$(e).height(),a=$(e).width();switch(0==a&&(a=300),0==i&&(i=200),t){case 8:o=-90,$(e).css("transform-origin","0 0"),$(e).css("transform","rotate("+o+"deg)"),$(e).css("margin-left","100%"),$(n).css("width",a+"px"),$(n).css("height",a+"px");break;case 3:o=180,$(e).css("transform-origin","0 0"),$(e).css("transform","rotate("+o+"deg)");break;case 6:o=90,$(e).css("transform-origin","0 0"),$(e).css("margin-left","100%"),$(e).css("transform","rotate("+o+"deg)"),$(n).css("width",a+"px"),$(n).css("height",a+"px")}};var Template=Template||{};function addMessage(e,t){Template.addMessage(e)}function addErrorMessage(e){Template.addErrorMessage(e)}function bindControls(){Template.bindControls()}function contentCreateForm(e,t){Template.initContentCreateForm(e,t)}function hideContentCreateForm(){Template.hideContentCreateForm()}function autoSave(e,t,n){return Template.autoSave(e,t,n)}function annotateContent(){$(".h-entry").fitVids(),$("time.dt-published").timeago()}Template.addMessage=function(e,t){void 0===t&&(t="alert-info"),void 0!==e&&$("div#page-messages").append('<div class="alert '+t+' col-md-10 col-md-offset-1"><button type="button" class="close" data-dismiss="alert">&times;</button>'+e+"</div>")},Template.addErrorMessage=function(e){Template.addMessage(e,"alert-danger")},Template.activateStarToggle=function(){$(".interactions .annotate-icon a.stars-toggle").each(function(){var e=$(this).attr("data-form-id"),t=$(this).find("i.fa"),n=t.closest("span.annotate-icon").find("a.stars");$("#"+e).submit(function(e){e.preventDefault(),$.ajax({type:"POST",url:$(this).attr("action"),data:$(this).serialize(),success:function(e){t.hasClass("fa-star")&&t.hasClass("far")?t.removeClass("far").addClass("fas"):t.removeClass("fas").addClass("far"),n.text(e.text)}})})})},Template.enableFormCandy=function(){$(".ctrl-enter-submit").keypress(function(e){var t=e.which?e.which:e.keyCode;10!=t&&13!=t||!e.ctrlKey&&!e.metaKey||$(this).closest("form").submit()})},Template.enablePagination=function(){$(".pager-xhr a").click(function(e){e.preventDefault();var t,n=$(this).closest(".pager-xhr"),o=parseInt(n.attr("data-offset")),i=parseInt(n.attr("data-limit")),a=parseInt(n.attr("data-count")),r=$("#"+n.attr("data-control-id")),s=n.attr("data-source-url"),l=$(this).attr("rel"),c=$(this).closest(".pager-xhr").find("li.newer"),f=$(this).closest(".pager-xhr").find("li.older");s=s.split("?")[0],"next"==l?(t=o-i)<0&&(t=0):(t=o+i)>a-1&&(t=a-1),s=s+"?offset="+t.toString()+"&limit="+i.toString(),r.load(s,function(e,o,s){"error"!=o&&(n.attr("data-offset",t.toString()),c.removeClass("pagination-disabled"),f.removeClass("pagination-disabled"),0==t&&c.addClass("pagination-disabled"),t>a-i&&f.addClass("pagination-disabled"),r.scrollTop(0))})})},Template.enableRichTextRequired=function(){$("textarea.validation-required").each(function(){var e=$(this).closest("form"),t=$(this),n=$(this).closest("div.richtext-container").find("div.alert");e.submit(function(e){n.hide(),0==t.val().length&&(e.preventDefault(),console.error("Required richtext field "+t.attr("name")+" is blank, preventing form submission"),n.show().focus())})})},Template.enableImageFallback=function(){$("img").on("error",function(){console.error("Loading fallback image "+known.config.displayUrl+"gfx/users/default.png"),$(this).attr("src",known.config.displayUrl+"gfx/users/default.png")})},Template.activateImagePreview=function(e){var t=$(e).closest("div.image-file-input").find("div.photo-preview"),n=$(e).closest("div.image-file-input").find("span.photo-filename"),o=$(e).closest("div.image-file-input").find(".preview");if(e.files&&e.files[0]){var i=new FileReader;i.onload=function(e){n.html(n.attr("data-nexttext"));try{var i=EXIF.readFromBinaryFile(base64ToArrayBuffer(this.result));ImageTools.exifRotateImg("#"+o.attr("id"),i.Orientation,"#"+t.attr("id"))}catch(e){console.error(e)}o.attr("src",e.target.result),o.show()},i.readAsDataURL(e.files[0])}},Template.autoSave=function(e,t,n){var o={};setInterval(function(){for(var i={},a=0;a<t.length;a++){var r=t[a],s="#"+r;n&&r in n&&(s=n[r]);var l=!1;$(s).val()!=o[r]&&(l=$(s).val()),!1!==l&&(i[r]=l,o[r]=l)}Object.keys(i).length>0&&$.post(wwwroot()+"autosave/",{context:e,elements:i,names:t},function(){})},1e4)},Template.isCreateFormVisible=!1,Template.bindControls=function(){$(".acl-ctrl-option").click(function(){$("#access-control-id").val($(this).attr("data-acl")),$("#acl-text").html($(this).html())}),$(".syndication-toggle input[type=checkbox]").bootstrapToggle(),$(".ignore-this").hide(),Security.activateACLControls(),Template.enableFormCandy(),Template.enableRichTextRequired(),$("#contentCreate .form-control").first().focus()},Template.initContentCreateForm=function(e,t){Template.isCreateFormVisible||(Template.isCreateFormVisible=!0,$.ajax(t,{dataType:"html",success:function(t){$("#contentCreate").html(t).slideDown(400),$("#contentTypeButtonBar").slideUp(400),window.contentCreateType=e,window.contentPage=!0,bindControls()},error:function(e){$("#contentTypeButtonBar").slideDown(400),Template.isCreateFormVisible=!1}}))},Template.hideContentCreateForm=function(){Template.isCreateFormVisible=!1,1==window.contentPage?($("#contentTypeButtonBar").slideDown(200),$("#contentCreate").slideUp(200)):window.history.length>1&&window.history.back()},function(e,t,n){if("standalone"in t&&t.standalone){var o,i=e.location,a=/^(a|html)$/i;e.addEventListener("click",function(e){for(o=e.target;!a.test(o.nodeName);)o=o.parentNode;"href"in o&&(o.href.indexOf("http")||~o.href.indexOf(i.host))&&!o.classList.contains("contentTypeButton")&&(e.preventDefault(),i.href=o.href)},!1)}}(document,window.navigator),$(document).ready(function(){$("body").on("click",function(e,t){var n=e.target;n.href&&-1===n.href.indexOf(window.location.origin)&&(n.target="_blank")})}),$(document).ready(function(){$.timeago.settings.cutoff=2592e6,annotateContent(),Template.enableFormCandy(),Template.enablePagination(),Template.enableRichTextRequired(),Template.enableImageFallback(),Template.activateStarToggle()});